{% extends 'dashboard/header.html' %}

{% load static %}
{% load humanize %}

{% block content %}
<!-- Page Preloder -->
<!--
<div id="preloder">
    <div class="loader"></div>
</div>
-->
<!-- Header Section Begin -->
<header class="header-section">
    <!-- BOTTOM BAR-->
    <div class="nav-item">
        <div class="container">
            <nav class="nav-menu mobile-menu">
                <ul>
                    <li><a href="/dashboard">Tablero</a></li>
                    <li class="active"><a href="/dashboard/productos">Productos</a></li>
                    <li><a href="/dashboard/pedidos">Pedidos</a>
                    <li><a href="/dashboard/mibodega">Mi bodega</a></li>
                    <li><a href="../logout">Salir</a></li>
                    </li>
                </ul>
            </nav>
            <!-- Mobile version-->
           <div id="mobile-menu-wrap"></div>
        </div>
    </div>
</header>
<!-- Header End -->

<div class="dashboard-main-wrapper">
    <!-- ============================================================== -->
    <!-- wrapper  -->
    <!-- ============================================================== -->
    <div class="dashboard-wrapper">
        <div class="dashboard-ecommerce">
            <div class="container-fluid dashboard-content ">
                <!-- ============================================================== -->
                <!-- pageheader  -->
                <!-- ============================================================== -->
                <div class="row">
                    <div class="col-xl-12 col-lg-12 col-md-12 col-sm-12 col-12">
                        <div class="page-header">
                            <h2 class="pageheader-title">Hola {{ cliente.cl_first_name }} {{ cliente.cl_last_name }}. Bienvenido a tu bodega {{ bodega.bd_name }}</h2>
                            <p class="pageheader-text">
                                Nulla euismod urna eros, sit amet scelerisque torton lectus vel mauris facilisis faucibus at enim quis massa lobortis rutrum.
                            </p>
                        </div>
                    </div>
                </div>
                <!-- ============================================================== -->
                <!-- end pageheader  -->
                <!-- ============================================================== -->
                <div class="ecommerce-widget">
                    <div class="row">
                        <!-- ============================================================== -->
                        <!-- productos en bodega  -->
                        <!-- ============================================================== -->
                        <div class="col-xl-9 col-lg-9 col-md-9 col-sm-12 col-12">
                            <div class="card">
                                <h5 class="card-header">Todos los productos en mi bodega</h5>
                                <div class="card-body p-0">
                                    <div class="table-responsive">
                                        <table class="table">
                                            <thead class="bg-light">
                                                <tr class="border-0">
                                                    <th class="border-0">Imágen</th>
                                                    <th class="border-0">Producto</th>
                                                    <th class="border-0">Categoria</th>
                                                    <th class="border-0">Marca</th>
                                                    <th class="border-0">Precio regular</th>
                                                    <th class="border-0">Precio con descuento</th>
                                                    <th class="border-0">¿Vender con descuento?</th>
                                                    <th class="border-0">% Descuento</th>
                                                    <th class="border-0">¿Disponible?</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <form id="products_to_update" action="">
                                                {% for product in ProductosEnBodega_list %}
                                                <tr>
                                                    <td>
                                                        <div class="m-r-10"><img src="{{STATIC_URL}}main/img/{{product.peb_product.pa_category}}/{{product.peb_product.pa_photo_small}}" alt="IMG" class="rounded" width="45"></div>
                                                    </td>
                                                    <td>{{ product.peb_product.pa_product }}</td>
                                                    <td>{{ product.peb_product.pa_category }}</td>
                                                    <td>{{ product.peb_product.pa_brand }}</td>
                                                    <td>
                                                        <input type="number" step="0.01" name="regular_price" id="{{ product.peb_ID }}" class="form-control" min="0" pattern="^[0-9\.]{1,}$" value="{{ product.peb_regular_price|floatformat:2|intcomma }}" required>
                                                    </td>
                                                    <td>
                                                        <input type="number" step="0.01"  name="discount_price" id="{{ product.peb_ID }}" class="form-control" min="0" pattern="^[0-9\.]{1,}$" value="{{ product.peb_discount_price|floatformat:2|intcomma }}" required>
                                                    </td>
                                                    <td>
                                                        {% if product.peb_discount_status == True %}
                                                            <input type="checkbox" name="discount_status" id="{{ product.peb_ID }}" class="form-check-input" checked>
                                                            <span class="badge-dot badge-success mr-1"></span>Sí
                                                        {% else %}
                                                            <input type="checkbox" name="discount_status" id="{{ product.peb_ID }}" class="form-check-input">
                                                            <span class="badge-dot badge-danger mr-1"></span>No
                                                        {% endif %}
                                                    </td>
                                                    <td>{{ product.peb_discount_rate|floatformat:2|intcomma }}</td>
                                                    <td>
                                                        {% if product.peb_status == True %}
                                                            <input type="checkbox" name="peb_status" id="{{ product.peb_ID }}" class="form-check-input" checked>
                                                            <span class="badge-dot badge-success mr-1"></span>Sí
                                                        {% else %}
                                                            <input type="checkbox" name="peb_status" id="{{ product.peb_ID }}" class="form-check-input">
                                                            <span class="badge-dot badge-danger mr-1"></span>No
                                                        {% endif %}
                                                    </td>
                                                </tr>
                                                {% endfor %}
                                                </form>
                                                <tr>
                                                    <td colspan="9"><button type="button" class="btn btn-outline-primary float-right" onclick="save_product_changes(); return false;">Guardar</button></td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- ============================================================== -->
                        <!-- end productos en bodega  -->
                        <!-- ============================================================== -->
                        <!-- ============================================================== -->
                        <!-- selected products statistics -->
                        <!-- ============================================================== -->
                        <div class="col-xl-3 col-lg-3 col-md-3 col-sm-12 col-12">
                            <div class="card">
                                <h5 class="card-header">Ventas por producto</h5>
                                <div class="card-body p-0">
                                    
                                </div>
                            </div>
                        </div>
                        <!-- ============================================================== -->
                        <!-- end selected products statistics  -->
                        <!-- ============================================================== -->
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- ============================================================== -->
    <!-- end wrapper  -->
    <!-- ============================================================== -->
</div>

<script type="text/javascript">
    /*
    function getCookie(name) {
        var cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            var cookies = document.cookie.split(';');
            for (var i = 0; i < cookies.length; i++) {
                var cookie = jQuery.trim(cookies[i]);
                // Does this cookie string begin with the name we want?
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    var csrftoken = getCookie('csrftoken');*/

    const numInputs = document.querySelectorAll('input[type=number]');
    numInputs.forEach(function(input) {
        input.addEventListener('change', function(e) {
            if (e.target.value == '') {
                e.target.value = 0;
            }
            if (e.target.value < 0) {
                e.target.value = 0;
            }
        })
    });
    function save_product_changes() {
        if ($("#products_to_update").validate().form()) {
            regular_price = document.getElementsByName("regular_price");
            discount_price = document.getElementsByName("discount_price");
            discount_status = document.getElementsByName("discount_status");
            peb_status = document.getElementsByName("peb_status");
            
            var dict_changes = [];
            for (i = 0; i < regular_price.length; i++) {
                data = {
                    key:                String(regular_price[i].id),
                    regular_price:      regular_price[i].value, 
                    discount_price:     discount_price[i].value,
                    discount_status:    discount_status[i].checked,
                    peb_status:         peb_status[i].checked
                }
                dict_changes.push(data);
            };
            let product_changes = JSON.stringify(dict_changes);

            $.ajax({
                headers: {'X-CSRFToken': '{{ csrf_token }}'},
                //url: "/dashboard/save_product_changes",
                url: "/dashboard/productos",
                type: "POST",
                dataType: "json",
                data: {
                    changes: product_changes
                }
            });
        } else {
            alert("Verifique los datos ingresados");
        };
    }
</script>

<!-- Latest Blog Section End -->
<!-- Js Plugins -->
<script src="{% static 'main/js/jquery-3.3.1.min.js' %}"></script> <!-- NEEDED FOR JQUERY -->
<script src="{% static 'main/js/jquery.validate.min.js' %}"></script> <!-- NEEDED FOR VALIDATING FORMS -->
<script src="{% static 'main/js/bootstrap.min.js' %}"></script>
<script src="{% static 'dashboard/js/jquery.slimscroll.js' %}"></script>
<script src="{% static 'dashboard/js/main-js.js' %}"></script>
<script src="{% static 'dashboard/js/Chart.bundle.min.js' %}"></script> <!-- NEEDED FOR DRAWING CHARTS -->
<script src="{% static 'dashboard/js/Chart.js' %}"></script> <!-- NEEDED FOR DRAWING CHARTS -->
<script src="{% static 'dashboard/js/jquery.slicknav.js' %}"></script> <!-- NEEDED FOR MOBILE NAVIGATION HEADER -->
<script src="{% static 'dashboard/js/dashboard-ecommerce.js' %}"></script> <!-- NEEDED FOR CURRENT SITE RENDERING -->
<script src="{% static 'dashboard/js/main.js' %}"></script>
<script src="{% static 'dashboard/js/product_detail.js' %}"></script>
{% endblock %}
