{% extends 'main/header.html' %}
{% load static %}

{% block content %}
<!-- Page Preloder -->


<!-- BOTTOM BAR -->
<nav class="nav-extended hide-on-med-and-down" style="background-color:#feb100 !important;color:#000000;font-weight:bold;">
    <div class="nav-wrapper">
        <ul style="display:inline-flex;list-style-type:none;">
            <li class="active"><a href="/" style="color:black;">Ofertas</a></li>
            <li><a href="/embutidos" style="color:black;">Embutidos</a></li>
            <li><a href="/vegetales" style="color:black;">Vegetales</a>
            <li><a href="/lacteos" style="color:black;">Lácteos</a></li>
            <li><a href="/abarrotes" style="color:black;">Abarrotes</a></li>
            <li><a href="/limpieza" style="color:black;">Limpieza</a></li>
            <li><a href="/licores" style="color:black;">Licores</a></li>
          </ul>
    </div>
</nav>
<!-- BOTTOM END -->
<!-- SIDENAV -->
<ul id="slide-out" class="sidenav" style="list-style-type:none;padding-left:0;">
    <li class="active"><a href="/">Ofertas</a></li>
    <li><a href="/embutidos">Embutidos</a></li>
    <li><a href="/vegetales">Vegetales</a>
    <li><a href="/lacteos">Lácteos</a></li>
    <li><a href="/abarrotes">Abarrotes</a></li>
    <li><a href="/limpieza">Limpieza</a></li>
    <li><a href="/licores">Licores</a></li>
</ul>
<!-- SIDENAV END -->

<!-- SLIDER -->
<div class="slider">
    <ul class="slides">
        <li style="background-color: #3fcc01;">
            <div class="caption center-align">
                <h3>¡Digital!</h3>
                <h5 class="light grey-text text-lighten-3">Ahora la bodega de la cuadra vende online.</h5>
                <!--<h5 class="light grey-text text-lighten-3">Now your local farm shop sells online.</h5>-->
                <a href="/unete" class="waves-effect waves-light btn" style="background-color: #feb100;">¡Únete!</a>
            </div>
        </li>
        <li style="background-color: #feb100;">
            <div class="caption center-align" id="faulty_slide">
                <h3>¡Compara!</h3>
                <h5 class="light grey-text text-lighten-3">Te damos los mejores precios de tu zona.</h5>
                <a href="/unete" class="waves-effect waves-light btn" style="background-color: #3fcc01;">¡Únete!</a>
            </div>
        </li>
        <li style="background-color: #3fcc01;">
            <div class="caption left-align">
                <h3>¡Seguro!</h3>
                <h5 class="light grey-text text-lighten-3">Paga a contraentrega.</h5>
                <a href="/unete" class="waves-effect waves-light btn" style="background-color: #feb100;">¡Únete!</a>
            </div>
        </li>
        <li style="background-color: #feb100;">
            <div class="caption left-align">
                <h3>¡A medida!</h3>
                <h5 class="light grey-text text-lighten-3">Encuentra justo lo que necesitas.</h5>
                <a href="/unete" class="waves-effect waves-light btn" style="background-color: #3fcc01;">¡Únete!</a>
            </div>
        </li>
        <li style="background-color: #3fcc01;">
            <div class="caption right-align">
                <h3>¡Comodidad!</h3>
                <h5 class="light grey-text text-lighten-3">Te traen tu compra o pasa a recogerla.</h5>
                <a href="/unete" class="waves-effect waves-light btn" style="background-color: #feb100;">¡Únete!</a>
            </div>
        </li>
    </ul>
</div>
<!-- SLIDER END -->

<!-- IF NO PRODUCTS AVAILABLE -->
{{ result_list }}
{% if result_list|length == 0 %}
    <div class="row">
        <h4>Seleccione su ubicación.</h4>
        <!-- Pin icon -->
        <a class="btn modal-trigger" id="remider_user_location_btn" data-target="user_location_modal" onclick="getLocation()" style="padding:0px 0px 0px 0px;background-color:#ffffff;color:#212529 !important;
        box-shadow:none;">
            <i class="material-icons" style="Margin:-10px 0px 0px 0px;">place</i>
        </a>
        <h5>No hay ofertas disponibles en su zona.</h5>
        <h3>Avísele a la bodega que puede ser la primera vendiendo por internet</h3>
    </div>
{% endif %}

<!-- PRODUCTS -->
<div class="row">
    {% load humanize %}
    {% for product in result_list %}
        <div class="col s6 m4 l3 xl2">
            <div class="card" style="text-align:center;">
                <div class="card-image" style="align-self:center">
                    {% if product.peb_product.pa_image %}
                        <img class="responsive-img" style="max-width:150px;" src="{{product.peb_product.pa_image.url}}" alt="IMG">
                    {% endif %}
                    <span style="background-color:#ff2322;font-weight:bold;padding:5px;font-size:16px;color:#fff;position:absolute;top:0px;left:0px;">{{ product.peb_discount_rate|floatformat:0|intcomma }}%</span>
                    <b style="font-size:20px;color:#feb100"> S/.{{product.peb_discount_price|floatformat:2|intcomma}}</b>
                    <span style="text-decoration:line-through;">S/.{{product.peb_regular_price|floatformat:2|intcomma}}</span>
                </div>
                <div class="card-content" style="color:#000000;padding:0px 0px 0px 0px;">
                    <b>{{product.peb_bodega.bd_name}}</b><br>
                    {{product.peb_product.pa_product}}
                </div>
                <div class="card-action">
                    <a class="btn" name="cart_add" id="{{product.pk}}" onclick="cart_add(this)" style="background-color:#feb100;padding:0px 10px 0px 10px">
                        <i class="material-icons">add_shopping_cart</i>
                    </a>
                </div>
            </div>
        </div>
    {% endfor %}
  </div>
<!-- PRODUCTS END-->

<!-- SHOPPING CART -->
{% include 'main/includes/shopping_cart.html' %}
<!-- SHOPPING CART END -->

<!-- BENEFICIOS -->
<section class="latest-blog spad">
    <div class="container">
        <div class="benefit-items">
            <div class="row">
                <div class="col-lg-4" align="center">
                    <div class="single-benefit">
                        <div class="sb-icon">
                            <img src="{% static 'main/img/icon-1.png' %}" alt="">
                        </div>
                        <div class="sb-text">
                            <h6>Envío económico</h6>
                            <p>Es la bodega de la cuadra.</p>
                        </div>
                    </div>
                </div>
                <div class="col-lg-4" align="center">
                    <div class="single-benefit">
                        <div class="sb-icon">
                            <img src="{% static 'main/img/icon-2.png' %}" alt="">
                        </div>
                        <div class="sb-text">
                            <h6>Rápido envío</h6>
                            <p>El bodeguero es tu vecino.</p>
                        </div>
                    </div>
                </div>
                <div class="col-lg-4" align="center">
                    <div class="single-benefit">
                        <div class="sb-icon">
                            <img src="{% static 'main/img/icon-3.png' %}" alt="">
                        </div>
                        <div class="sb-text">
                            <h6>100% pago seguro</h6>
                            <p>En efectivo a <b>contraentrega.</b><br>Próximamente con tarjeta via web.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<script>
    // Workaroung bug on first slide
    document.addEventListener('DOMContentLoaded', function() {
        var elems = document.querySelectorAll('.slider');
        var instances = M.Slider.init(elems, {interval: 5000});
        var instance = M.Slider.getInstance(elems[0]);
        instance.next();
    });
    // Add product to cart
    function cart_add(product) {
        M.toast({html: 'Producto añadido'})
        $.ajax({
                headers: {'X-CSRFToken': '{{ csrf_token }}'},
                url: "/cart_add",
                type: "POST",
                dataType: "json",
                data: {
                    product_id: String(product.id)
                },
                success: function(response) {
                    new_values = response.success;
                    if (new_values['new_added'] == "True") {
                        // Create cart item
                        $("#cart_tbody").append('<tr name="'+new_values['product_pk']+'" style="border-top: 1px solid rgba(0, 0, 0, 0.12);"><td rowspan="2" style="text-align:center;"><img class="responsive-img hide-on-med-and-up" style="max-width:50px;" src="'+new_values['pa_image_url']+'" alt="IMG"><img class="responsive-img hide-on-small-only" style="max-width:100px;" src="'+new_values['pa_image_url']+'" alt="IMG"></td><td colspan="1"><h6>'+new_values['product']+'</h6></td><td colspan="3" style="text-align:center;"><a class="btn" name="remove_item" id="'+new_values['product_pk']+'" onclick="remove_item_from_cart(this)" style="background-color:#feb100;padding:3px 0px 3px 0px">Borrar</a></td></tr><tr name="'+new_values['product_pk']+'"><td style="text-align:left;"><h6>P.U: S/.'+parseFloat(new_values['price']).toFixed(2)+'</h6></td><td style="text-align:center;"><a class="btn" name="add_pk" id="'+new_values['product_pk']+'" onclick="reduce_quantity_cart_item(this)" style="background-color:#feb100;padding:3px 0px 3px 0px"><i class="material-icons">remove</i></a></td><td name="product_qty" id="'+new_values['product_pk']+'" style="text-align:center;">'+new_values['quantity']+'</td><td style="text-align:center;"><a class="btn" name="add_pk" id="'+new_values['product_pk']+'" onclick="increase_quantity_cart_item(this)" style="background-color:#feb100;padding:3px 0px 3px 0px"><i class="material-icons">add</i></a></td></tr>');
                        // Update cart total price
                        $("#total_cart_price").html('S/.'+parseFloat(new_values['total_price']).toFixed(2));
                    }
                    else {
                        $("#total_cart_price").html('S/.'+parseFloat(new_values['total_price']).toFixed(2));
                        product_qty = document.getElementsByName("product_qty");
                        for (i = 0; i < product_qty.length; i++) {
                            if (String(product_qty[i].id) == String(new_values['product_pk'])) {
                                $(product_qty[i]).html(String(new_values['quantity']));
                            }
                        }
                    }
                },
                error: function(){
                    location.reload();
                }
            }
        );
    };
</script>

<!-- Js Plugins -->
<script src="{% static 'main/js/jquery-3.3.1.min.js' %}"></script>
<script src="{% static 'main/js/materialize.min.js' %}"></script>
<script src="{% static 'main/js/store-front.js' %}"></script>
{% endblock %}