{% extends 'main/header.html' %}
{% load static %}

{% block content %}
<!-- We are gonna accept information from the users (POST)-->
<!-- Page Preloder -->


<!-- BREADCRUMB -->
<div class="breacrumb-section">
    <div class="container" style="margin-top: 10px;">
        <div class="breadcrumb-text">
            <a href="dashboard/mibodega"><i class="material-icons" style="margin-top: 10px;">home</i><span>Mi bodega</span></a>
            <span> / Cambiar contraseña</span>            
        </div>
    </div>
</div>
<!-- BREADCRUMB END -->

<!-- Register Section Begin -->
<div class="register-login-section spad">
    <div class="container">
        <div class="row">
            <div class="col-lg-6 offset-lg-3">
                <div class="register-form">
                    <h2>Regístrese</h2>
                    <style>
                        label{
                            font-size: 1.5rem !important;
                            color: black !important;
                        }
                    </style>
                    <form method="POST" id="change_password_form">
                        {% csrf_token %}
                        {% load widget_tweaks %}

                        {% for hidden_field in pc_form.hidden_fields %}
                        {{ hidden_field }}
                        {% endfor %}

                        {% if pc_form.non_field_errors %}
                            <div class="alert alert-danger" role="alert">
                                {% for error in pc_form.non_field_errors %}
                                {{ error }}
                                {% endfor %}
                            </div>
                        {% endif %}

                        <!-- USER FORM -->
                        {% for field in pc_form.visible_fields %}
                            <div class="form-group">
                                {{ field.label_tag }}

                                {% if pc_form.is_bound %}
                                {% if field.errors %}
                                    {% render_field field class="form-control is-invalid" %}
                                    {% for error in field.errors %}
                                    <div class="invalid-feedback">
                                        {{ error }}
                                    </div>
                                    {% endfor %}
                                {% else %}
                                    {% render_field field class="form-control is-valid" %}
                                {% endif %}
                                {% else %}
                                {% render_field field class="form-control" %}
                                {% endif %}

                                {% if field.help_text %}
                                <small class="form-text text-muted">{{ field.help_text }}</small>
                                {% endif %}
                            </div>
                        {% endfor %}
                        <!-- USER FORM -->
                        <button type="button" class="btn waves-effect waves-light" style="background-color:#feb100;color:#000000;font-weight:bold;" onclick="submit_register(); return false">Registrar</button>
                    </form>
                    <div class="switch-login">
                        <a href="/login" class="or-login">o inicie sesión</a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- Register Form Section End -->

<!-- START TOAST -->
<div>
    <div class="toast" id="wrong_username" role="alert" aria-live="assertive" aria-atomic="true" style="z-index: 2;background-color: red;position: fixed; top:4%; right: 5%;">
        <div class="toast-header">
            <strong class="mr-auto">El usuario debe ser mínimo 5 letras y/o números sin espacios</strong>
            <button type="button" class="ml-2 mb-1 close" data-dismiss="toast" aria-label="Close">
                <span aria-hidden="true">&times;</span>
            </button>
        </div>
    </div>
    <div class="toast" id="wrong_email" role="alert" aria-live="assertive" aria-atomic="true" style="z-index: 2;background-color: red;position: fixed; top:10%; right: 5%;">
        <div class="toast-header">
            <strong class="mr-auto">El e-mail ingresado no es válido</strong>
            <button type="button" class="ml-2 mb-1 close" data-dismiss="toast" aria-label="Close">
                <span aria-hidden="true">&times;</span>
            </button>
        </div>
    </div>
    <div class="toast" id="password_mismatch" role="alert" aria-live="assertive" aria-atomic="true" style="z-index: 2;background-color: red;position: fixed; top:16%; right: 5%;">
        <div class="toast-header">
            <strong class="mr-auto">Las contraseñas no coinciden</strong>
            <button type="button" class="ml-2 mb-1 close" data-dismiss="toast" aria-label="Close">
                <span aria-hidden="true">&times;</span>
            </button>
        </div>
    </div>
    <div class="toast" id="password_too_short" role="alert" aria-live="assertive" aria-atomic="true" style="z-index: 2;background-color: red;position: fixed; top:22%; right: 5%;">
        <div class="toast-header">
            <strong class="mr-auto">La contraseña es muy corta</strong>
            <button type="button" class="ml-2 mb-1 close" data-dismiss="toast" aria-label="Close">
                <span aria-hidden="true">&times;</span>
            </button>
        </div>
    </div>
    <div class="toast" id="terms_n_cond" role="alert" aria-live="assertive" aria-atomic="true" style="z-index: 2;background-color: red;position: fixed; top:28%; right: 5%;">
        <div class="toast-header">
            <strong class="mr-auto">Lea y acepte los términos y condiciones</strong>
            <button type="button" class="ml-2 mb-1 close" data-dismiss="toast" aria-label="Close">
                <span aria-hidden="true">&times;</span>
            </button>
        </div>
    </div>
</div>
<!-- END TOAST -->

<script>
    function submit_register() {
        // Verify that password1 and password2 are the same
        var valid = true;
        username = document.getElementsByName('username')[0];
        email = document.getElementsByName('email')[0];
        password_1 = document.getElementsByName('password1')[0];
        password_2 = document.getElementsByName('password2')[0];
        reg_ex = new RegExp('^[a-zA-Z0-9]{5,}$');
        m = username.value.search(reg_ex);
        reg_ex = new RegExp('^[A-Za-z0-9+_.-]+@(.+)$');
        n = email.value.search(reg_ex);
        terms_n_conditions = document.getElementById('terms_n_conditions');
        // Check if username is already in use
        if ($("#id_username")[0].value.length > 4) {
            $.ajax({
                headers: {'X-CSRFToken': '{{ csrf_token }}'},
                url: "/search_username",
                type: "POST",
                dataType: "json",
                data: {
                    "username": $("#id_username")[0].value
                },
                success: function(response) {
                    valid = true;
                    new_values = response.success;
                    $("#id_username").parent().children()[2].remove();
                    $("#id_username").parent().append('<small>Mínimo 5 letras y/o números sin espacios.</small>');
                    $("#id_username").parent().children(2).css('color', '#495057');
                    $("input[name=username]").css('border-color', '#495057');
                },
                error: function(response){
                    valid = false;
                    new_values = response.responseJSON.error;
                    $("#id_username").parent().children()[2].remove();
                    $("#id_username").parent().append('<small>'+new_values+'</small>');
                    $("#id_username").parent().children(2).css('color', 'red');
                    $("input[name=username]").css('border-color', 'red');
                }
            });
        };
        if (m < 0) {
            valid = false;
            $('#wrong_username').show();
            $('#wrong_username').toast({delay: 3000});
            $('#wrong_username').toast('show');
            $("input[name=username]").css('border-color', 'red');
        } else {$("input[name=username]").css('border-color', '#ced4da');};
        if (n < 0) {
            valid = false;
            $("#wrong_email").show();
            $('#wrong_email').toast({delay: 3000});
            $('#wrong_email').toast('show');
            $("input[name=email]").css('border-color', 'red');
        } else {$("input[name=email]").css('border-color', '#ced4da');};
        if (password_1.value != password_2.value) {
            valid = false;
            $("#password_mismatch").show();
            $('#password_mismatch').toast({delay: 3000});
            $('#password_mismatch').toast('show');
            $("input[name=password1]").css('border-color', 'red');
            $("input[name=password2]").css('border-color', 'red');
        } else {$("input[name=password1]").css('border-color', '#ced4da');$("input[name=password2]").css('border-color', '#ced4da');};
        if (password_1.value.length < 8) {
            valid = false;
            $("#password_too_short").show();
            $('#password_too_short').toast({delay: 3000});
            $('#password_too_short').toast('show');
            $("input[name=password1]").css('border-color', 'red');
            $("input[name=password2]").css('border-color', 'red');
        } else {$("input[name=password1]").css('border-color', '#ced4da');$("input[name=password2]").css('border-color', '#ced4da');};
        if (terms_n_conditions.checked == false) {
            valid = false;
            $("#terms_n_cond").show();
            $('#terms_n_cond').toast({delay: 3000});
            $('#terms_n_cond').toast('show');
            $("#terms_n_conditions").css('outline', '2px solid red');
        } else {$("#terms_n_conditions").css('outline', 'none');};
        // If all previous validations are true, submit form
        if (valid == true){document.getElementById("client_registration_form").submit();}
    };
</script>
<script src="{% static 'main/js/jquery-3.3.1.min.js' %}"></script>
<script src="{% static 'main/js/materialize.min.js' %}"></script>
<script src="{% static 'main/js/bootstrap.min.js' %}"></script>

<script>
    // Hide toasts on page load
    function on_pageload() {
        $('#wrong_username').hide();
        $('#wrong_email').hide();
        $('#password_mismatch').hide();
        $('#password_too_short').hide();
        $('#wrong_ruc').hide();
        $('#terms_n_cond').hide();
    };
    on_pageload();
</script>
<script>
    $(document).ready(function(){
        $("#id_username").on("input", function() {
            // Check if username is already in use
            if ($("#id_username")[0].value.length > 4) {
                $.ajax({
                    headers: {'X-CSRFToken': '{{ csrf_token }}'},
                    url: "/search_username",
                    type: "POST",
                    dataType: "json",
                    data: {
                        "username": $("#id_username")[0].value
                    },
                    success: function(response) {
                        new_values = response.success;
                        $("#id_username").parent().children()[2].remove();
                        $("#id_username").parent().append('<small>Mínimo 5 letras y/o números sin espacios.</small>');
                        $("#id_username").parent().children(2).css('color', '#495057');
                        $("input[name=username]").css('border-color', '#495057');
                    },
                    error: function(response){
                        new_values = response.responseJSON.error;
                        $("#id_username").parent().children()[2].remove();
                        $("#id_username").parent().append('<small>'+new_values+'</small>');
                        $("#id_username").parent().children(2).css('color', 'red');
                        $("input[name=username]").css('border-color', 'red');
                    }
                });
            } else {
                $("#id_username").parent().children()[2].remove();
                $("#id_username").parent().append('<small>Mínimo 5 letras y/o números sin espacios.</small>');
                $("#id_username").parent().children(2).css('color', '#495057');
                $("input[name=username]").css('border-color', '#495057');
            };
        });
    });
</script>
{% endblock %}