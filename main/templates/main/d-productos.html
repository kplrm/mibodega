{% extends 'main/d-header.html' %}

{% load static %}
{% load humanize %}

{% block content %}
<!-- Page Preloder -->
<!--
<div id="preloder">
    <div class="loader"></div>
</div>
-->
<!-- Header Section Begin -->
<header class="header-section">
    <nav class="nav nav-pills nav-fill">
        <a class="nav-item nav-link" style="font-weight: bold;color: black; background: #feb100;border-radius: 0rem;place-content: center;" href="/dashboard">Tablero</a>
        <a class="nav-item nav-link active" style="border-radius: 0rem;place-content: center;" href="/dashboard/productos">Productos</a>
        <a class="nav-item nav-link" style="font-weight: bold;color: black; background: #feb100;border-radius: 0rem;place-content: center;" href="/dashboard/pedidos">Pedidos</a>
        <a class="nav-item nav-link" style="font-weight: bold;color: black; background: #feb100;border-radius: 0rem;place-content: center;" href="/dashboard/mibodega">Mi bodega</a>
        <a class="nav-item nav-link" style="font-weight: bold;color: black; background: #feb100;border-radius: 0rem;place-content: center;" href="../">Alimentos.pe</a>
        <a class="nav-item nav-link" style="font-weight: bold;color: black; background: #feb100;border-radius: 0rem;place-content: center;" href="../logout">Salir</a>
    </nav>
</header>
<!-- Header End -->

<div class="dashboard-main-wrapper">
    <!-- ============================================================== -->
    <!-- wrapper  -->
    <!-- ============================================================== -->
    <div class="dashboard-wrapper">
        <div class="dashboard-ecommerce">
            <div class="container-fluid dashboard-content ">
                <!-- ============================================================== -->
                <!-- pageheader  -->
                <!-- ============================================================== -->
                <div class="row">
                    <div class="col-xl-12 col-lg-12 col-md-12 col-sm-12 col-12">
                        <div class="page-header">
                            <h2 class="pageheader-title">Hola {{ cliente.cl_first_name }} {{ cliente.cl_last_name }}.<br>Bienvenido a tu bodega {{ bodega.bd_name }}</h2>
                            <p class="pageheader-text">
                                Mis productos en Alimentos.pe
                            </p>
                        </div>
                    </div>
                </div>
                <!-- ============================================================== -->
                <!-- end pageheader  -->
                <!-- ============================================================== -->
                <div class="ecommerce-widget">
                    <div class="row">
                        <table class="table">
                            <tbody>
                                <tr>
                                    <td colspan="9"><a class="btn btn-primary float-right" data-toggle="modal" data-target="#add_product_modal">+Añadir producto</a></td>
                                </tr>
                            </tbody>
                        </table>
                        <!-- ============================================================== -->
                        <!-- Modal add product -->
                        <!-- ============================================================== -->
                        <div class="modal fade" id="add_product_modal" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
                            <div class="modal-dialog modal-dialog-centered modal-xl" role="document">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <h5 class="modal-title" id="exampleModalLongTitle" style="text-align:center;">Añadir producto</h5>
                                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                            <span aria-hidden="true">&times;</span>
                                        </button>
                                    </div>
                                    <div class="modal-body" style="overflow-y: auto !important;">
                                        <div class="input-field" style="position: relative; box-shadow: 0px 8px 20px 0px rgba(0, 0, 0, 0.15);border-bottom: 2px solid #00bbec;">
                                            <input id="search-box" type="text" onkeyup="search_missing_product()" placeholder="Escriba aquí el producto que quiere buscar" style="width: 100%; box-sizing: border-box;"/>
                                        </div>
                                        <style>
                                            .tableFixHead          { overflow-y: auto; height: 60vh; }
                                            .tableFixHead thead th { position: sticky; top: 0; }
                                        </style>
                                        <div class="tableFixHead">
                                            <table class="table">
                                                <thead class="bg-light">
                                                    <tr class="border-0">
                                                        <th class="border-0" style="background-color:#f8f9fa;z-index: 2;">Añadir</th>
                                                        <th class="border-0" style="background-color:#f8f9fa;z-index: 2;">Imagen</th>
                                                        <th class="border-0" style="background-color:#f8f9fa;z-index: 2;">Producto</th>
                                                        <!--<th class="border-0">Categoría</th>-->
                                                        <th class="border-0" style="background-color:#f8f9fa;z-index: 2;">Marca</th>
                                                    </tr>
                                                </thead>
                                                <form id="products_to_add" action="">
                                                    <tbody id="products_to_add_container">
                                                        <!--<div class="container" id="products_to_add_container">-->
                                                            {% for product_faltante in ProductosAprobados_missing %}
                                                                <tr name="missing_products" class="c_products_to_add">
                                                                    <td><input type="checkbox" name="item_to_add" id="{{ product_faltante.pa_ID }}" class="form-check-input show-toast" onchange="add_new_products()" style="position:sticky;"></td>
                                                                    <td>
                                                                        <div class="m-r-10">
                                                                            {% if product_faltante.pa_image %}
                                                                                <img src="{{product_faltante.pa_image.url}}" alt="IMG" class="rounded" width="45">
                                                                            {% endif %}
                                                                        </div>
                                                                    </td>
                                                                    <td>{{ product_faltante.pa_product }}</td>
                                                                    <!--<td>{{ product_faltante.pa_category }}</td>-->
                                                                    <td>{{ product_faltante.pa_brand }}</td>
                                                                </tr>
                                                            {% endfor %}
                                                        <!--</div>-->
                                                    </tbody>
                                                </form>
                                            </table>
                                        </div>
                                    </div>
                                    <div class="modal-footer">
                                        <button type="button" class="btn btn-outline-primary float-right" data-dismiss="modal" onclick="add_new_products(); return false;">+Añadir producto</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- ============================================================== -->
                        <!-- end modal add product -->
                        <!-- ============================================================== -->
                    </div>
                    <div class="row">
                        <!-- ============================================================== -->
                        <!-- productos en bodega  -->
                        <!-- ============================================================== -->
                        <div class="col-xl-9 col-lg-9 col-md-12 col-sm-12 col-12">
                            <div class="card">
                                <h5 class="card-header">Todos los productos en mi bodega</h5>
                                <div class="card-body p-0">
                                    <div class="table-responsive">
                                        <style>
                                            .tableFixHead          { overflow-y: auto; height: 70vh; }
                                            .tableFixHead thead th { position: sticky; top: 0; }
                                        </style>
                                        <div class="tableFixHead">
                                            <table class="table">
                                                <thead class="bg-light">
                                                    <tr class="border-0">
                                                        <th class="border-0" style="background-color:#f8f9fa;z-index: 2;">Imágen</th>
                                                        <th class="border-0" style="background-color:#f8f9fa;z-index: 2;">Producto</th>
                                                        <!--<th class="border-0">Categoria</th>
                                                        <th class="border-0">Marca</th>-->
                                                        <th class="border-0" style="background-color:#f8f9fa;z-index: 2;" style="min-width:90px">Precio regular</th>
                                                        <th class="border-0" style="background-color:#f8f9fa;z-index: 2;">¿Disponible?</th>
                                                        <th class="border-0" style="background-color:#f8f9fa;z-index: 2;">¿Vender con descuento?</th>
                                                        <th class="border-0" style="background-color:#f8f9fa;z-index: 2;min-width:90px">Precio con descuento</th>
                                                        <th class="border-0" style="background-color:#f8f9fa;z-index: 2;">Descuento</th>
                                                        <th class="border-0" style="background-color:#f8f9fa;z-index: 2;">¿Eliminar?</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    <form id="products_to_update" action="">
                                                    {% for product in ProductosEnBodega_list %}
                                                    <tr name="product_row" id="{{ product.peb_ID }}">
                                                        <td>
                                                            <div class="m-r-10">
                                                                {% if product.peb_product.pa_image %}
                                                                    <img src="{{product.peb_product.pa_image.url}}" alt="IMG" class="rounded" width="45">
                                                                {% endif %}
                                                            </div>
                                                        </td>
                                                        <td><a id="{{ product.peb_product.pa_ID }}" style="text-decoration:underline;" onclick="see_sales_detail(this); return false;">{{ product.peb_product.pa_product }}</a></td>
                                                        <!--<td>{{ product.peb_product.pa_category }}</td>
                                                        <td>{{ product.peb_product.pa_brand }}</td>-->
                                                        <td style="min-width:90px">
                                                            <input type="number" step="0.01" name="regular_price" id="{{ product.peb_ID }}" class="form-control" min="0" pattern="^[0-9\.]{1,}$" value="{{ product.peb_regular_price|floatformat:2|intcomma }}" required>
                                                        </td>
                                                        <td>
                                                            {% if product.peb_status == True %}
                                                                <input type="checkbox" name="peb_status" id="{{ product.peb_ID }}" class="form-check-input" checked style="position:relative;" onclick="peb_status_change(this)"/>
                                                                <span class="badge-dot badge-success mr-1"></span>Sí
                                                            {% else %}
                                                                <input type="checkbox" name="peb_status" id="{{ product.peb_ID }}" class="form-check-input" style="position:relative;" onclick="peb_status_change(this)"/>
                                                                <span class="badge-dot badge-danger mr-1"></span>No
                                                            {% endif %}
                                                        </td>
                                                        <td>
                                                            {% if product.peb_discount_status == True %}
                                                                <input type="checkbox" name="discount_status" id="{{ product.peb_ID }}" class="form-check-input" checked style="position:relative;" onclick="discount_status_change(this)"/>
                                                                <span class="badge-dot badge-success mr-1"></span>Sí
                                                            {% else %}
                                                                <!--<input type="checkbox" name="discount_status" id="{{ product.peb_ID }}" class="form-check-input" style="padding:0px;"/>-->
                                                                <input type="checkbox" name="discount_status" id="{{ product.peb_ID }}" class="form-check-input" style="position:relative;" onclick="discount_status_change(this)"/>
                                                                <span class="badge-dot badge-danger mr-1"></span>No
                                                            {% endif %}
                                                        </td>
                                                        <td style="min-width:90px">
                                                            <input type="number" step="0.01"  name="discount_price" id="{{ product.peb_ID }}" class="form-control" min="0" pattern="^[0-9\.]{1,}$" value="{{ product.peb_discount_price|floatformat:2|intcomma }}" required>
                                                        </td>
                                                        <td name="discount_rate" id="{{ product.peb_ID }}">{{ product.peb_discount_rate|floatformat:0|intcomma }}%</td>
                                                        <td>
                                                            <button type="button" class="btn btn-outline-danger float-right" id="{{ product.peb_ID }}" onclick="delete_item(this); return false;">Eliminar</button>
                                                        </td>
                                                    </tr>
                                                    {% endfor %}
                                                    </form>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- ============================================================== -->
                        <!-- end productos en bodega  -->
                        <!-- ============================================================== -->
                        <!-- ============================================================== -->
                        <!-- selected products statistics -->
                        <!-- ============================================================== -->
                        <div class="col-xl-3 col-lg-3 col-md-12 col-sm-12 col-12">
                            <div class="card">
                                <h5 class="card-header">Precios de venta por producto (últimos 30 días)</h5>
                                <div class="card-body p-0">
                                    <table class="table">
                                        <thead class="bg-light">
                                            <tr class="border-0">
                                                <th class="border-0">Precio</th>
                                                <th class="border-0">Cantidad vendida</th>
                                            </tr>
                                        </thead>
                                        <tbody id="product_details">
                                            <tr class="border-0">
                                                <th class="border-0">Haz click en un producto para ver el cuántos fueron vendidos y a qué precio.</th>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                        <!-- ============================================================== -->
                        <!-- end selected products statistics  -->
                        <!-- ============================================================== -->
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- ============================================================== -->
    <!-- end wrapper  -->
    <!-- ============================================================== -->
</div>
<script type="text/javascript">
    // Event listener for number input
    const numInputs = document.querySelectorAll('input[type=number]');
    numInputs.forEach(function(input) {
        input.addEventListener('change', function(e) {
            if (e.target.value == '') {
                e.target.value = 0;
            }
            if (e.target.value < 0) {
                e.target.value = 0;
            }
            save_product_changes();
        })
    });
    function search_missing_product() {
        // Get search words
        search_text = document.getElementById("search-box").value
        search_words = search_text.split(" ");

        // Look for those words in current object
        var product_faltante = [];
        var dict = {};
        {% for product_faltante in ProductosAprobados_missing %}
            search_score = 0;
            for (i = 0; i < search_words.length; i++) {
                // Normalize string (eliminates accents)
                string_producto = String("{{ product_faltante.pa_product }}");
                string_producto = string_producto.normalize("NFD").replace(/[\u0300-\u036f]/g, "")
                search_w = search_words[i];
                search_w = search_w.normalize("NFD").replace(/[\u0300-\u036f]/g, "")
                
                // Look for matching word
                reg_ex = new RegExp('^(.*?(' + search_w + ')[^$]*)$', 'i');
                n = string_producto.search(reg_ex);
                search_score += n;
            };
            if (search_score == 0) {
                dict = {
                    id: "{{ product_faltante.pa_ID }}",
                    product: "{{ product_faltante.pa_product }}",
                    img: "{{ product_faltante.pa_image.url }}",
                    brand: "{{ product_faltante.pa_brand }}",
                    score: search_score
                };
                product_faltante.push(dict);
            }
        {% endfor %}

        // Print remove current results and add new search results
        $("tr").remove(".c_products_to_add");
        {% for product_faltante in ProductosAprobados_missing %}
            for (i = 0; i < product_faltante.length; i++) {
                if (String("{{ product_faltante.pa_ID }}") == String(product_faltante[i].id)) {
                    $("#products_to_add_container").append('<tr name="missing_products" class="c_products_to_add"><td><input type="checkbox" name="item_to_add" id="'+String(product_faltante[i].id)+'" class="form-check-input show-toast" onchange="add_new_products()" style="position:sticky;"></td><td><div class="m-r-10"><img src="'+String(product_faltante[i].img)+'" alt="IMG" class="rounded" width="45"></div></td><td>'+String(product_faltante[i].product)+'</td><td>'+String(product_faltante[i].brand)+'</td></tr>');
                }
            }
        {% endfor %}
    };
    function save_product_changes() {
        if ($("#products_to_update").validate().form()) {
            regular_price = document.getElementsByName("regular_price");
            discount_price = document.getElementsByName("discount_price");
            discount_status = document.getElementsByName("discount_status");
            peb_status = document.getElementsByName("peb_status");
            discount_rate = document.getElementsByName("discount_rate");
            
            var new_discount_rate = 0;
            var dict_changes = [];
            for (i = 0; i < regular_price.length; i++) {
                if (regular_price[i].value > 0 && discount_price[i].value > 0) {
                    new_discount_rate = (discount_price[i].value - regular_price[i].value)/regular_price[i].value*100;
                } else {
                    new_discount_rate = 0;
                }
                data = {
                    key:                String(regular_price[i].id),
                    regular_price:      regular_price[i].value, 
                    discount_price:     discount_price[i].value,
                    discount_status:    discount_status[i].checked,
                    peb_status:         peb_status[i].checked,
                    n_discount_rate:    new_discount_rate
                }
                dict_changes.push(data);
                $(discount_rate[i]).html(String(parseFloat(new_discount_rate).toFixed(0))+'%');
            };
            let product_changes = JSON.stringify(dict_changes);

            $.ajax({
                headers: {'X-CSRFToken': '{{ csrf_token }}'},
                //url: "/dashboard/save_product_changes",
                url: "/dashboard/productos",
                type: "POST",
                dataType: "json",
                data: {
                    changes: product_changes
                },
                success: function(){
                    //location.reload();
                    ;
                },
                error: function(){
                    //location.reload();
                    ;
                }
            });
        } else {
            alert("Verifique los datos ingresados");
        };
    };
    function add_new_products() {
        console.log("adding new product...");
        if ($("#products_to_add").validate().form()) {
            console.log("validating new product...");
            item_to_add = document.getElementsByName("item_to_add");
            var dict_to_add = [];
            for (i = 0; i < item_to_add.length; i++) {
                if (item_to_add[i].checked == true) {
                    data = {
                        key: String(item_to_add[i].id),
                    }
                    dict_to_add.push(data);
                    $(item_to_add[i]).parent().parent().remove();
                } else {}
            };
            let product_additions = JSON.stringify(dict_to_add);

            $.ajax({
                headers: {'X-CSRFToken': '{{ csrf_token }}'},
                //url: "/dashboard/save_product_changes",
                url: "/dashboard/productos",
                type: "POST",
                dataType: "json",
                data: {
                    additions: product_additions
                },
                success: function(response){
                    console.log("el exito...");
                    var details = JSON.parse(response.success);
                    console.log(details);
                    $("#myToast").toast({ autohide: true, animation: true, delay: 3000 });
                    $("#myToast").toast('show');
                    //location.reload();
                },
                error: function(){
                    console.log("keep trying...");
                    //location.reload();
                }
            });
        } else {
            alert("Verifique los datos ingresados");
        };
    };
    function delete_item(item_to_delete) {
        $.ajax({
                headers: {'X-CSRFToken': '{{ csrf_token }}'},
                url: "/dashboard/remove_product",
                type: "POST",
                dataType: "json",
                data: {
                    key: item_to_delete.id
                },
                success: function(){
                    product_rows = document.getElementsByName("product_row");
                    for (i = 0; i < product_rows.length; i++) {
                        if (product_rows[i].id == item_to_delete.id) {
                            var row_to_delete = product_rows[i];
                            break;
                        } else {}
                    };
                    row_to_delete.remove();
                    location.reload();
                },
                error: function(){
                    location.reload();
                }
            }
        );
    };
    function see_sales_detail(product_detail) {
        $.ajax({
                headers: {'X-CSRFToken': '{{ csrf_token }}'},
                url: "/dashboard/see_sales_detail",
                type: "POST",
                dataType: "json",
                data: {
                    product_id: product_detail.id,
                    bodega_id: "{{ bodega.bd_ID }}"
                },
                success: function(response) {
                    var details = JSON.parse(response.success);
                    $("#product_details").html('');
                    for (i = 0; i < details.length; i++) {
                        $("#product_details").append('<tr class="border-0"><th class="border-0">S/.'+ parseFloat(details[i][0]).toFixed(2) +'</th><th class="border-0">'+ parseFloat(details[i][1]) +'</th>)</tr>');
                    };
                },
                error: function(){
                    location.reload();
                }
            }
        );
    };
    function peb_status_change(input) {        
        if(input.checked == true) {
            $(input).parent().html('<input type="checkbox" name="peb_status" id="'+input.id+'" class="form-check-input" checked style="position:relative;" onclick="peb_status_change(this)"/><span class="badge-dot badge-success mr-1"></span>Sí');
        } else {
            $(input).parent().html('<input type="checkbox" name="peb_status" id="'+input.id+'" class="form-check-input" style="position:relative;" onclick="peb_status_change(this)"/><span class="badge-dot badge-danger mr-1"></span>No');
        }
        save_product_changes();
    }
    function discount_status_change(input) {        
        if(input.checked == true) {
            $(input).parent().html('<input type="checkbox" name="discount_status" id="'+input.id+'" class="form-check-input" checked style="position:relative;" onclick="discount_status_change(this)"/><span class="badge-dot badge-success mr-1"></span>Sí');
        } else {
            $(input).parent().html('<input type="checkbox" name="discount_status" id="'+input.id+'" class="form-check-input" style="position:relative;" onclick="discount_status_change(this)"/><span class="badge-dot badge-danger mr-1"></span>No');
        }
        save_product_changes();
    }
</script>

<!-- TOAST -->
<div>
    <div class="toast" id="myToast" role="alert" aria-live="assertive" aria-atomic="true" style="z-index: 9999 !important;background-color: green;position: fixed; top:10%; right: 5%;">
        <div class="toast-header">
            <strong class="mr-auto">Producto añadido</strong>
            <button type="button" class="ml-2 mb-1 close" data-dismiss="toast" aria-label="Close">
                <span aria-hidden="true">&times;</span>
            </button>
        </div>
    </div>
</div>

<!-- Latest Blog Section End -->
<!-- Js Plugins -->
<script src="{% static 'main/js/jquery-3.3.1.min.js' %}"></script> <!-- NEEDED FOR JQUERY -->
<script src="{% static 'main/js/jquery.validate.min.js' %}"></script> <!-- NEEDED FOR VALIDATING FORMS -->
<script src="{% static 'main/js/bootstrap.min.js' %}"></script>
<script>
    $(document).ready(function(){
        // Reload after closing add new products modal
        $('#add_product_modal').on('hidden.bs.modal', function () {
            location.reload();
        })
        // Initialize toast on click display
        $(".show-toast").click(function(){
            $("#myToast").toast({ autohide: true, animation: true, delay: 2000 });
            $("#myToast").toast('show');
        });
    });
</script>
{% endblock %}
