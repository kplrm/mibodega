{% extends 'main/header.html' %}
{% load static %}


{% block content %}
<!-- Page Preloder -->
<!--<div id="preloder">
    <div class="loader"></div>
</div>-->

<!-- BOTTOM BAR -->
<nav class="nav-extended hide-on-med-and-down" style="background-color:#feb100 !important;color:#000000;font-weight:bold;">
    <div class="nav-wrapper">
        <ul style="display:inline-flex;list-style-type:none;">
            <li><a href="/" style="color:black;">Ofertas</a></li>
            <li><a href="/embutidos" style="color:black;">Embutidos</a></li>
            <li><a href="/vegetales" style="color:black;">Vegetales</a>
            <li><a href="/lacteos" style="color:black;">Lácteos</a></li>
            <li><a href="/abarrotes" style="color:black;">Abarrotes</a></li>
            <li><a href="/limpieza" style="color:black;">Limpieza</a></li>
            <li><a href="/licores" style="color:black;">Licores</a></li>
          </ul>
    </div>
</nav>
<!-- BOTTOM END -->
<!-- SIDENAV -->
<ul id="slide-out" class="sidenav" style="list-style-type:none;padding-left:0;">
    <li><a href="/">Ofertas</a></li>
    <li><a href="/embutidos">Embutidos</a></li>
    <li><a href="/vegetales">Vegetales</a>
    <li><a href="/lacteos">Lácteos</a></li>
    <li><a href="/abarrotes">Abarrotes</a></li>
    <li><a href="/limpieza">Limpieza</a></li>
    <li><a href="/licores">Licores</a></li>
</ul>
<!-- SIDENAV END -->

<!-- Shopping Cart Section Begin -->
<script>
    function validate_fir(input) {
        var validityState_object = input.validity;
        if(validityState_object.patternMismatch) {
            input.setCustomValidity('Use solo letras y espacio');
            input.reportValidity();
        } else if (validityState_object.valueMissing ) {
            input.setCustomValidity('Escriba su nombre.');
            input.reportValidity();
        } else {
            input.setCustomValidity('');
        }
    };
    function validate_last(input) {
        var validityState_object = input.validity;
        if(validityState_object.patternMismatch) {
            input.setCustomValidity('Use solo letras y espacio');
            input.reportValidity();
        } else if (validityState_object.valueMissing ) {
            input.setCustomValidity('Escriba su apellido.');
            input.reportValidity();
        } else {
            input.setCustomValidity('');
        }
    };
    function validate_street(input) {
        var validityState_object = input.validity;
        if (validityState_object.valueMissing ) {
            input.setCustomValidity('Seleccione en el mapa su dirección y corrija su dirección.');
            input.reportValidity();
        } else {
            input.setCustomValidity('');
        }
    };
    function validate_phone(input) {
        var validityState_object = input.validity;
        if(validityState_object.patternMismatch) {
            input.setCustomValidity('Use solo números');
            input.reportValidity();
        } else if (validityState_object.badInput ) {
            input.setCustomValidity('Use solo números');
            input.reportValidity();
        } else if (validityState_object.valueMissing ) {
            input.setCustomValidity('Ingrese su teléfono.');
            input.reportValidity();
        } else {
            input.setCustomValidity('');
        }
    };
    function check(input) {
        if (input.validity) {
            if (input.validity.valid === true) {
                ;
            } else {
                input.reportValidity();
            }
        }
    };
</script>

<div class="container" style="padding-top: 20px !important;">
    {% if user.is_authenticated == False %}
        <div class="row">
            <div class="col s6">
                <a href="/login" class="btn waves-effect waves-light" style="background-color:#feb100 !important;color:#000000;font-weight:bold;">Inicie sesión</a>
            </div>
            <div class="col s6">
                <a href="/register" class="btn waves-effect waves-light" style="background-color:#feb100 !important;color:#000000;font-weight:bold;">Regístrese</a>
            </div>
        </div>
    {% endif %}
</div>

<div class="container">
    <div class="row">
        <div class="col xl6 l6 m6 s12">
            <form id="checkout_form" action="" class="">
                <h4>Sus datos</h4>
                <div class="row" style="text-align:Left">
                    <div class="col s6">
                        <label for="fir">Nombre<span>*</span></label>
                        <input type=text id="fir" class="form-control" pattern="^[A-Za-z\s]{1,}$" value="{% if cliente.cl_first_name != None %}{{cliente.cl_first_name}}{% endif %}" oninput="validate_fir(this)" required>
                    </div>
                    <div class="col s6">
                        <label for="last">Apellido<span>*</span></label>
                        <input type="text" id="last" class="form-control" pattern="[A-Za-z\s]{1,}" value="{% if cliente.cl_last_name != None %}{{cliente.cl_last_name}}{% endif %}" oninput="validate_last(this)" required>
                    </div>
                </div>
                <div class="row" style="text-align:Left">
                    <div class="col s12">
                        <label for="street">Dirección (Seleccione en el mapa y luego corrija el texto)<span>*</span></label>
                        <input type="text" id="street" class="form-control" class="street-first" value="{% if cliente.cl_address != None %}{{cliente.cl_address}}{% endif %}" oninput="validate_street(this)" required>
                    </div>
                </div>
                <div class="row" style="text-align:center">
                    <div class="col s12">
                        <input type="hidden" id="geolocation" class="form-control" value="{% if cliente.cl_geolocation != None %}{{cliente.cl_geolocation}}{% endif %}">
                        <style>
                            @media (max-width: 600px) {
                                .map_cart {
                                    max-width: 80vw;
                                }
                            }
                            @media only screen and (min-width: 601px) {
                                .map_cart {
                                    max-width: 40vw;
                                }
                            }
                        </style>
                        <div class="map_cart" id="map_cart" style="position:relative;height:50vh;width:100%;"></div>
                        
                        <script>
                            // To get reverse geolocation and update user's current location
                            function reverse_geolocation(latitude, longitude) {
                                update_user_location(latitude,longitude);
                                map.panTo(new L.LatLng(latitude, longitude));
                                document.getElementById("geolocation").value = 'SRID=4326;POINT ('+longitude+' '+latitude+')';
                                const Http = new XMLHttpRequest();
                                const url='https://reverse.geocoder.ls.hereapi.com/6.2/reversegeocode.json'+
                                        '?apiKey=BVDjzA8alE1JmhleAW9EQPOD261SOClD-DjbwCEos4U'+
                                        '&mode=retrieveAddresses'+
                                        '&prox='
                                        +latitude+','+longitude+',250';
//                                console.log(url);
//                                console.log("{{user_location}}")
                                Http.open("GET", url);
                                Http.send();
                                Http.onreadystatechange = (e) => {
                                    const address_json = JSON.parse( Http.responseText );
                                    document.getElementById("street").value = String(address_json.Response.View[0].Result[0].Location.Address.Label);
                                };
                            };
                            // Get location stored on client data or get current session location
                            var marker_client;
                            var mapcart = L.map('map_cart');
                            mapcart.invalidateSize();
                            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                            }).addTo(mapcart);

                            // In case client has geolocation
                            if ("{{cliente.cl_geolocation}}" != "None" && "{{cliente.cl_geolocation}}" != "") {
//                                console.log("cliente.cl_geolocation: {{cliente.cl_geolocation}}");
                                mapcart.setView([ "{{cliente.cl_geolocation.y}}", "{{cliente.cl_geolocation.x}}" ], 15, {paddingBottomRight: [50,50]});
                                reverse_geolocation("{{ cliente.cl_geolocation.y }}","{{ cliente.cl_geolocation.x }}");
                                if (marker_client) {mapcart.removeLayer(marker_client);};
                                marker_client = new L.marker( ["{{ cliente.cl_geolocation.y }}", "{{ cliente.cl_geolocation.x }}"], {draggable:'true'})
                                    .on('dragend', function(event){reverse_geolocation(event.target._latlng.lat, event.target._latlng.lng);});
                                mapcart.addLayer(marker_client);
                            // Retrieves session location
                            } else {
//                                console.log("user_location: {{user_location}}");
                                mapcart.setView([ "{{user_location.y}}", "{{user_location.x}}" ], 15, {paddingBottomRight: [50,50]});
                                reverse_geolocation("{{ user_location.y }}","{{ user_location.x }}");
                                if (marker_client) {mapcart.removeLayer(marker_client);};
                                marker_client = new L.marker( ["{{ user_location.y }}", "{{ user_location.x }}"], {draggable:'true'})
                                    .on('dragend', function(event){reverse_geolocation(event.target._latlng.lat, event.target._latlng.lng);});
                                mapcart.addLayer(marker_client);
                            }
                            
                            // When click on the mapcart
                            mapcart.on('click', function (e) {
                                reverse_geolocation(e.latlng.lat, e.latlng.lng);
                                if (marker_client) {mapcart.removeLayer(marker_client);};
                                marker_client = new L.marker(e.latlng, {draggable:'true'})
                                .on('dragend', function(event){reverse_geolocation(event.target._latlng.lat, event.target._latlng.lng);});
                                mapcart.addLayer(marker_client);
                            });
                            //mapcart.on('click', onMapClick);
                        </script>
                    </div>
                </div>
                <div class="row">
                    <div class="col s6">
                        <label for="email">Email<span>*</span></label>
                        <input type="email" id="email" class="form-control" value="{% if cliente.cl_email != None %}{{cliente.cl_email}}{% endif %}" required>
                    </div>
                    <!-- TO HIDE ARROWS IN INPUT TYPE NUMBER BEGIN -->
                    <style>
                        /* Chrome, Safari, Edge, Opera */
                        input::-webkit-outer-spin-button,
                        input::-webkit-inner-spin-button {
                            -webkit-appearance: none;
                            margin: 0;
                        }
                        /* Firefox */
                        input[type=number] {-moz-appearance: textfield;}
                    </style>
                    <!-- TO HIDE ARROWS IN INPUT TYPE NUMBER END -->
                    <div class="col s6">
                        <label for="phone">Celular<span>*</span></label>
                        <input type="text" id="phone" class="form-control" name="phone" pattern="^[0-9]*$" maxlength="9" value="{% if cliente.cl_phone != None %}{{cliente.cl_phone}}{% endif %}" oninput="validate_phone(this)" required>
                    </div>
                </div>
                <div class="row">
                    <div class="col s12">
                        <label for="comments">Comentarios para la bodega</label>
                        <textarea id="comments" class="form-control" rows="3" placeholder="Pregunte por productos adicionales que no encontró en la tienda, o escriba alguna nota sobre su pedido."></textarea>
                    </div>
                </div>
                <!-- CHECK TO UPDATE CLIENT PERSONAL INFORMATION -->
                <div class="row">
                    {% if cliente.cl_user != None %}
                        <div class="col s12">
                            <div class="create-item">
                                <label for="acc-create">
                                    ¿Desea guardar sus datos?
                                    <input type="checkbox" id="acc-create">
                                    <span class="checkmark"></span>
                                </label>
                            </div>
                        </div>
                    {% endif %}
                </div>
            </form>
        </div>
        {% load humanize %}
        <div class="col xl6 l6 m6 s12">
            <h4>Su pedido</h4>
            <!-- Dropdown button start -->
            <div class="row" style="text-align:center">
                <div class="col s12">
                    <a class='dropdown-trigger btn' href='#' data-target='results_options' style="background-color:#feb100 !important;color:#000000;font-weight:bold;">Comparar</a>
                    <ul id='results_options' class='dropdown-content' style="padding: 5px;">
                        {% for result in result_list %}
                            <li><a onclick="change_option('{{forloop.counter}}')">Opción {{ forloop.counter }}: S/.{{result.0|floatformat:2|intcomma}}</a></li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
            <!-- Dropdown button end -->
            <input type="hidden" id="counter" value=""> <!-- SUPPORT VARIABLE FOR BUYING -->
            {% for result in result_list %}
                {% if result.2 == 1 %} <!-- IF ALL PRODUCTS ARE AT ONE BODEGA -->
                <div id="result_list_{{ forloop.counter }}">
                        <div class="row" style="text-align:center">
                            <div class="col s12" style="background-color:#feb100;columns:#000000;;text-transform:uppercase">
                                <span>{{ result.1.1.2 }}</span>
                            </div>
                        </div>
                        <div class="row" style="text-align:center">
                            <div>
                                <table>
                                    <thead>
                                        <tr>
                                            <th style="width:70%;text-align:Left">
                                                Producto
                                            </th>
                                            <th style="width:10%;text-align:center">
                                                P.U.(S/.)
                                            </th>
                                            <th style="width:5%;text-align:center">
                                                Cant.
                                            </th>
                                            <th style="width:10%;text-align:center">
                                                S.T.(S/.)
                                            </th>
                                            <th style="width:5%;text-align:right">
                                                
                                            </th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <input type="hidden" id="product_list_{{forloop.counter}}" value="">
                                        <script>
                                            document.getElementById("counter").value = "{{forloop.counter}}";
                                        </script>
                                        {% for item, p_quantity, sub_total in result.1.1.3 %}
                                            <tr>
                                                <td style="width:70%;text-align:Left">
                                                    {% if item.peb_discount_status == True %}<img src="https://img.icons8.com/color/48/000000/discount--v1.png" style="width: 25px;"/>{% endif %}
                                                    {{ item.peb_product.pa_product }}
                                                </td>
                                                <td style="width:10%;text-align:center">
                                                    {% if item.peb_discount_status == True %}{{item.peb_discount_price|floatformat:2|intcomma}}{% endif %}
                                                    {% if item.peb_discount_status == False %}{{item.peb_regular_price|floatformat:2|intcomma}}{% endif %}
                                                </td>
                                                <td style="width:5%;text-align:center">
                                                    {{ p_quantity }}
                                                </td>
                                                <td style="width:10%;text-align:right">
                                                    {{sub_total|floatformat:2|intcomma}}
                                                </td>
                                                <td style="width:5%;text-align:right">
                                                    <button class="btn" value="{{item.peb_product.pa_ID}}" onclick="delete_item(this.value);return false" style="background-color: #ffffff;padding:0px 3px 0px 3px;border-style: none;box-shadow:none;"><i class="material-icons" style="font-size: 14px;color:#000000;">cancel</i></button>
                                                </td>
                                            </tr>
                                            <script>
                                                counter = document.getElementById("counter").value;
                                                val = document.getElementById("product_list_"+counter);
                                                val.value = String(val.value) + '{{ item.peb_ID }}' + ',' + '{{ p_quantity }};';
                                            </script>
                                        {% endfor %}
                                        <tr>
                                            <td colspan="3" style="text-align:right">
                                                Delivery (S/.)
                                            </td>
                                            <td colspan="2" style="text-align:left">
                                                {{result.1.1.4|floatformat:2|intcomma}}
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div class="order-total">
                            <ul class="order-table" style="color:#252525;font-size:16px;text-transform:uppercase;font-weight:1000">
                                Total <span>S/.{{result.0|floatformat:2|intcomma}}</span>
                            </ul>
                        </div>
                        <div class="order-btn">
                            <button type="button" id="btn_comprar" class="btn waves-effect waves-light" style="background-color:#feb100 !important;color:#000000;font-weight:bold;" onclick="submit_checkout(document.getElementById('product_list_'+'{{forloop.counter}}').value); return false">Comprar</button>
                        </div>
                    </div>
                {% else %} <!-- IF ALL PRODUCTS DIVIDED BETWEEN TWO BODEGAS -->
                    <div id="result_list_{{ forloop.counter }}">
                        <!-- BODEGA 1 -->
                        <div class="row" style="text-align:center">
                            <div class="col s12" style="background-color:#feb100;columns:#000000;;text-transform:uppercase">
                                <span>{{ result.1.1.2 }}</span>
                            </div>
                        </div>
                        <div class="row" style="text-align:center">
                            <div>
                                <table>
                                    <thead>
                                        <tr>
                                            <th style="width:70%;text-align:Left">
                                                Producto
                                            </th>
                                            <th style="width:10%;text-align:center">
                                                P.U.(S/.)
                                            </th>
                                            <th style="width:5%;text-align:center">
                                                Cant.
                                            </th>
                                            <th style="width:10%;text-align:center">
                                                S.T.(S/.)
                                            </th>
                                            <th style="width:5%;text-align:right">
                                                
                                            </th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <input type="hidden" id="product_list_{{forloop.counter}}" value="">
                                        <script>
                                            document.getElementById("counter").value = "{{forloop.counter}}";
                                        </script>
                                        {% for item, p_quantity, sub_total in result.1.1.3 %}
                                            <tr>
                                                <td style="width:70%;text-align:Left">
                                                    {% if item.peb_discount_status == True %}<img src="https://img.icons8.com/color/48/000000/discount--v1.png" style="width: 25px;"/>{% endif %}
                                                    {{ item.peb_product.pa_product }}
                                                </td>
                                                <td style="width:10%;text-align:center">
                                                    {% if item.peb_discount_status == True %}{{item.peb_discount_price|floatformat:2|intcomma}}{% endif %}
                                                    {% if item.peb_discount_status == False %}{{item.peb_regular_price|floatformat:2|intcomma}}{% endif %}
                                                </td>
                                                <td style="width:5%;text-align:center">
                                                    {{ p_quantity }}
                                                </td>
                                                <td style="width:10%;text-align:right">
                                                    {{sub_total|floatformat:2|intcomma}}
                                                </td>
                                                <td style="width:5%;text-align:right">
                                                    <button class="btn" value="{{item.peb_product.pa_ID}}" onclick="delete_item(this.value);return false" style="background-color: #ffffff;padding:0px 3px 0px 3px;border-style: none;box-shadow:none;"><i class="material-icons" style="font-size: 14px;color:#000000;">cancel</i></button>
                                                </td>
                                            </tr>
                                            <script>
                                                counter = document.getElementById("counter").value;
                                                val = document.getElementById("product_list_"+counter);
                                                val.value = String(val.value) + '{{ item.peb_ID }}' + ',' + '{{ p_quantity }};';
                                            </script>
                                        {% endfor %}
                                        <tr>
                                            <td colspan="3" style="text-align:right">
                                                Delivery (S/.)
                                            </td>
                                            <td colspan="2" style="text-align:left">
                                                {{result.1.1.4|floatformat:2|intcomma}}
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div class="row" style="text-align:center">
                            <div class="col s12" style="background-color:#feb100;columns:#000000;;text-transform:uppercase">
                                <span>{{ result.2.1.2 }}</span>
                            </div>
                        </div>
                        <!-- BODEGA 2 -->
                        <div class="row" style="text-align:center">
                            <div>
                                <table>
                                    <thead>
                                        <tr>
                                            <th style="width:70%;text-align:Left">
                                                Producto
                                            </th>
                                            <th style="width:10%;text-align:center">
                                                P.U.(S/.)
                                            </th>
                                            <th style="width:5%;text-align:center">
                                                Cant.
                                            </th>
                                            <th style="width:10%;text-align:center">
                                                S.T.(S/.)
                                            </th>
                                            <th style="width:5%;text-align:right">
                                                
                                            </th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for item, p_quantity, sub_total in result.2.1.3 %}
                                            <tr>
                                                <td style="width:70%;text-align:Left">
                                                    {% if item.peb_discount_status == True %}<img src="https://img.icons8.com/color/48/000000/discount--v1.png" style="width: 25px;"/>{% endif %}
                                                    {{ item.peb_product.pa_product }}
                                                </td>
                                                <td style="width:10%;text-align:center">
                                                    {% if item.peb_discount_status == True %}{{item.peb_discount_price|floatformat:2|intcomma}}{% endif %}
                                                    {% if item.peb_discount_status == False %}{{item.peb_regular_price|floatformat:2|intcomma}}{% endif %}
                                                </td>
                                                <td style="width:5%;text-align:center">
                                                    {{ p_quantity }}
                                                </td>
                                                <td style="width:10%;text-align:right">
                                                    {{sub_total|floatformat:2|intcomma}}
                                                </td>
                                                <td style="width:5%;text-align:right">
                                                    <button class="btn" value="{{item.peb_product.pa_ID}}" onclick="delete_item(this.value);return false" style="background-color: #ffffff;padding:0px 3px 0px 3px;border-style: none;box-shadow:none;"><i class="material-icons" style="font-size: 14px;color:#000000;">cancel</i></button>
                                                </td>
                                            </tr>
                                            <script>
                                                counter = document.getElementById("counter").value;
                                                val = document.getElementById("product_list_"+counter);
                                                val.value = String(val.value) + '{{ item.peb_ID }}' + ',' + '{{ p_quantity }};';
                                            </script>
                                        {% endfor %}
                                        <tr>
                                            <td colspan="3" style="text-align:right">
                                                Delivery (S/.)
                                            </td>
                                            <td colspan="2" style="text-align:left">
                                                {{result.2.1.4|floatformat:2|intcomma}}
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div class="order-total">
                            <ul class="order-table" style="color:#252525;font-size:16px;text-transform:uppercase;font-weight:1000">
                                Total <span>S/.{{result.0|floatformat:2|intcomma}}</span>
                            </ul>
                        </div>
                        <div class="order-btn">
                            <button type="button" id="btn_comprar" class="btn waves-effect waves-light" style="background-color:#feb100 !important;color:#000000;font-weight:bold;" onclick="submit_checkout(document.getElementById('product_list_'+'{{forloop.counter}}').value); return false">Comprar</button>
                        </div>
                    </div>
                {% endif %}
            {% endfor %}
        </div>
    </div>
</div>
<!-- Modal -->
<div class="modal fade" id="popup_modal" tabindex="-1" role="dialog" aria-labelledby="popupModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
    <div class="modal-content">
        <div class="modal-header">
        <h5 class="modal-title" id="popupModalLabel">Trail</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
        </button>
        </div>
        <div class="modal-body" id="popupModalBody" style="text-align:left;">
        ...
        </div>
        <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cerrar</button>
        </div>
    </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        var elems = document.querySelectorAll('.dropdown-trigger');
        var instances = M.Dropdown.init(elems, {});
    });
    // Show only best result
    {% for result in result_list %}
        if ("{{ forloop.counter }}" != "1") {
            $('#result_list_{{ forloop.counter }}').hide();
        }
    {% endfor %}
    // Show other results on click
    function change_option(option) {
        {% for result in result_list %}
            $('#result_list_{{ forloop.counter }}').hide();
        {% endfor %}
        $('#result_list_'+option).show();
    };
    // Delete cart item
    function delete_item(item_pa_ID) {
        $.ajax({
            headers: {'X-CSRFToken': '{{ csrf_token }}'},
            url: "/remove_cart_item",
            type: "POST",
            dataType: "json",
            data:   {
                        'item_pa_ID': item_pa_ID,
                        'cart_obj_ID': "{{cart_obj.crt_ID}}",
                    },
            success: function(){
                location.reload();
            },
            error: function(){
                location.reload();
            }
        });
    };
    // Submit checkout
    function submit_checkout(result_list) {
        usr_first = document.getElementById("fir").value;
        usr_last = document.getElementById("last").value;
        usr_street = document.getElementById("street").value;
        usr_geolocation = document.getElementById("geolocation").value;
        usr_email = document.getElementById("email").value;
        usr_phone = document.getElementById("phone").value;
        usr_comments = document.getElementById("comments").value;
        var parse_result_list = result_list.split(';');
        var dict_changes = [];
        for (i = 0; i < parse_result_list.length; i++) {
            var parse_key_qty = parse_result_list[i].split(',');
            // If condition to protect against empty items
            if (parse_key_qty[0] != "") {
                data = {
                key:    String(parse_key_qty[0]),
                qty:    String(parse_key_qty[1])
            };
            dict_changes.push(data);
            };
        }
        let products_to_buy = JSON.stringify(dict_changes);
        if ($("#checkout_form").validate().form() && "{{cart_obj.crt_total_price}}" != 0 && usr_geolocation != "") {
            // submit with AJAX
            $.ajax({
                headers: {'X-CSRFToken': '{{ csrf_token }}'},
                url: "/submit_checkout",
                type: "POST",
                dataType: "json",
                data: {
                    'cart_obj_ID': "{{cart_obj.crt_ID}}",
                    'usr_first': usr_first,
                    'usr_last': usr_last,
                    'usr_street': usr_street,
                    'usr_geolocation': usr_geolocation,
                    'usr_email': usr_email,
                    'usr_phone': usr_phone,
                    'usr_comments': usr_comments,
                    'products_to_buy': products_to_buy
                },
                success: function(response){
                    var msg = "";
                    if (response.success.length == 0) { // This triggers when at least there is one item in the basket
                        $("#popupModalLabel").html('');
                        $("#popupModalLabel").append('Su compra ha sido procesada');
                        $("#popupModalBody").html('');
                        $("#popupModalBody").append('Gracias por su compra');
                        $('#popup_modal').modal({ show: true });
                        //$('#popup_modal').on('hidden.bs.modal', function (e) {
                        //    window.location.href = '../';
                        //})
                        //location.reload();
                        //window.location.href = '../'
                    } else if (response.success.length > 0) {
                        for (i = 0; i < response.success.length; i++) {
                            msg += "<li>" + String(response.success[i]) + "</li>"
                        };
                        $("#popupModalLabel").html('');
                        $("#popupModalLabel").append('Su compra ha sido procesada');
                        $("#popupModalBody").html('');
                        $("#popupModalBody").append('Gracias por su compra.\r\n'+'Los siguientes productos no han sido incluidos por ya no encontrarse disponibles:<br>'+msg);
                        $('#popup_modal').modal({ show: true });
                    }
                },
                error: function(response){ // This triggers in case all items in the basket get unavailable
                    var msg = "";
                    for (i = 0; i < response.responseJSON.error.length; i++) {
                        msg += "<li>" + String(response.responseJSON.error[i]) + "</li>"
                    };
                    $("#popupModalLabel").html('');
                    $("#popupModalLabel").append('No ha podido procesarse su compra');
                    $("#popupModalBody").html('');
                    $("#popupModalBody").append('Los siguientes productos no han sido incluidos por ya no encontrarse disponibles:<br>'+msg);
                    $('#popup_modal').modal({ show: true });
                }
            });
        } else if ({{cart_obj.crt_total_price}} == 0) { // In case basket is empty
            alert("Su cesta se encuentra vacía");
        } else {
            alert("Seleccione en el mapa su ubicación"); // In case missing to select position
        }
    }
</script>
<!-- Js Plugins -->
<script src="{% static 'main/js/jquery-3.3.1.min.js' %}"></script>
<script src="{% static 'main/js/jquery.validate.min.js' %}"></script> <!-- NEEDED FOR VALIDATING FORMS -->
<script src="{% static 'main/js/materialize.min.js' %}"></script>
<script src="{% static 'main/js/store-front.js' %}"></script>
{% endblock %}
