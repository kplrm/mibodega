<!--
<h3>Seleccione su bodega</h3>
<p><br></p>
<label for="bodega_name">Bodega:</label>
<input type="text" class="form-control" id="bodega_name" value="Cercanas" disabled>
<p><br></p>
<input type="hidden" class="form-control" id="bodega_id" value="Cercanas" disabled>
-->
<div id="mapid"></div>
<script type = "text/javascript">
    // Initializes map
    var map = L.map('mapid').setView([ -12.046374, -77.0427934 ], 14);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map);
    //const customMarkerIcon = L.AwesomeMarkers.icon({
    const customMarkerIcon = L.icon({
        //"extraClasses": "fa-rotate-0", 
        //"icon": "shopping-cart", 
        //"iconColor": "white", 
        //"markerColor": "orange", 
        //"prefix": "glyphicon"
        "icon": <i class="material-icons">location_searching</i>
    });
    // Get user geolocation
    function showLocation(position) {
        var latitude = position.coords.latitude;
        var longitude = position.coords.longitude;
        map.panTo(new L.LatLng(latitude, longitude));
        // Request for shops nearby user
        $.ajax({
            headers: {'X-CSRFToken': '{{ csrf_token }}'},
            url: "/get_nearby_shops",
            type: "POST",
            dataType: "json",
            data: {
                'latitude': latitude,
                'longitude': longitude
            },
            success: function(response){ // make a marker at the shops nearby
                for (i = 0; i < response.success.length; i++) {
                    var marker = L.marker([ response.success[i][0],response.success[i][1] ], {icon: customMarkerIcon, bd_name: response.success[i][2], bd_id: response.success[i][3]})
                    .addTo(map)
                    .bindPopup( response.success[i][2] )
                    .closePopup()
                    .on('click', function onClick(e) {
                        document.getElementById("bodega_name").value = this.options.bd_name;
                        document.getElementById("bodega_id").value = this.options.bd_id;
                    });
                };
            },
            error: function(response){ // This triggers in case all items in the basket get unavailable
                console.log(response);
            }
        });
    }
    function errorHandler(err) {
        if(err.code == 1) {
            alert("Error: Access is denied!");
        } else if( err.code == 2) {
            alert("Error: Position is unavailable!");
        }
    }
    function getLocation() {
        console.log("getting location");
        if(navigator.geolocation) {
            // timeout at 60000 milliseconds (60 seconds)
            var options = {timeout:60000};
            navigator.geolocation.getCurrentPosition(showLocation, errorHandler, options);
        } else {
            alert("Sorry, browser does not support geolocation!");
        }
    }
</script>