
<!-- Data fields -->
<input type="hidden" class="form-control" id="usr_lat" value="-12.046374" disabled>
<input type="hidden" class="form-control" id="usr_lng" value="-77.0427934" disabled>

<!-- Map -->
<div id="map" style="height:inherit;"></div>
<style>
    @media only screen and (max-width: 600px) {
        .awesome-marker i {
            margin-top: 10px;
        }
    }
    @media only screen and (min-width: 601px) {
        .awesome-marker i {
            margin-top: -15px;
        }
    }
</style>
<script type = "text/javascript">
    // Initializes map
    var marker;
    var shops_markers = [];
    var map = L.map('map', {maxBounds: [[-90, -180],[90, 180]], maxBoundsViscosity: 1.0}).setView([ -12.046374, -77.0427934 ], 14);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { noWrap: true, maxZoom: "10", maxNativeZoom: "25",
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map);
    const customMarkerIcon = L.AwesomeMarkers.icon({
        "icon": "fa-shopping-basket",
        "prefix": "fa",
        "markerColor": "orange",
        "iconColor": "white",
        "extraClasses": "fa-rotate-0"
    });

    // Request user current location
    function getCurrentLocation() {
        if(navigator.geolocation) {
            // timeout at 60000 milliseconds (60 seconds)
            var options = {timeout:60000};
            navigator.geolocation.getCurrentPosition(showCurrentLocation, errorHandler, options);
        } else {
            alert("Sorry, browser does not support geolocation!");
        }
    }
    // Permission granted. Get user location
    function showCurrentLocation(position) {
        var latitude = position.coords.latitude;
        var longitude = position.coords.longitude;
        document.getElementById("usr_lat").value = latitude;
        document.getElementById("usr_lng").value = longitude;
        map.invalidateSize();
        map.panTo(new L.LatLng(latitude, longitude));
        // Make a marker in current user's location
        if (marker != undefined) {
            map.removeLayer(marker);
        };
        marker = new L.marker([ latitude, longitude ], {draggable:'true'})
            .on('dragend', function(event){
                update_user_location(event.target._latlng.lat,event.target._latlng.lng);
                onMapMoveEnd();
            }).addTo(map);
        map.addLayer(marker);
        // Request for shops nearby user
        update_user_location(latitude,longitude);
        get_nearby_shops(latitude,longitude);
    }

    // Request user saved location
    function getLocation() {
        if(navigator.geolocation) {
            // timeout at 60000 milliseconds (60 seconds)
            var options = {timeout:60000};
            navigator.geolocation.getCurrentPosition(showLocation, errorHandler, options);
        } else {
            alert("Sorry, browser does not support geolocation!");
        }
    }
    
    // Permission granted. Get user location
    function showLocation(position) {
        if (parseFloat("{{user_location.x}}") == 0 && parseFloat("{{user_location.y}}") == 0) {
            var latitude = position.coords.latitude;
            var longitude = position.coords.longitude;
        } else if (parseFloat("{{user_location.y}}") != position.coords.latitude && parseFloat("{{user_location.x}}") != position.coords.longitude) {
            var latitude = parseFloat("{{user_location.y}}");
            var longitude = parseFloat("{{user_location.x}}");
        } else {
            var latitude = position.coords.latitude;
            var longitude = position.coords.longitude;
        }
        document.getElementById("usr_lat").value = latitude;
        document.getElementById("usr_lng").value = longitude;
        map.invalidateSize();
        map.panTo(new L.LatLng(latitude, longitude));
        // Make a marker in current user's location
        if (marker != undefined) {
            map.removeLayer(marker);
        };
        marker = new L.marker([ latitude, longitude ], {draggable:'true'})
            .on('dragend', function(event){
                update_user_location(event.target._latlng.lat,event.target._latlng.lng);
                onMapMoveEnd();
            }).addTo(map);
            //console.log(event.target._latlng.lat);//console.log(event.target._latlng.lng);
        map.addLayer(marker);
        // Request for shops nearby user
        update_user_location(latitude,longitude);
        get_nearby_shops(latitude,longitude);
    }
    // Permision denied
    function errorHandler(err) {
        map.invalidateSize();
        // Default location
        update_user_location(-12.046374, -77.0427934);
        get_nearby_shops(-12.046374, -77.0427934);
        if(err.code == 1) {
            alert("Haz click en el mapa para ubicar tu ubicación actual.");
        } else if( err.code == 2) {
            alert("Error: Tu ubicación no está disponible.");
        }
    }
    // Click to change user's position marker
    function onMapClick(e) {
        if (marker != undefined) {
            map.removeLayer(marker);
        };
        //marker = new L.marker(e.latlng, {draggable:'true'}).addTo(map);
        //update_user_location(e.latlng.lat,e.latlng.lng);

        marker = new L.marker(e.latlng, {draggable:'true'})
            .on('dragend', function(event){
                update_user_location(event.target._latlng.lat,event.target._latlng.lng);
                onMapMoveEnd();
            }).addTo(map);

            update_user_location(e.latlng.lat,e.latlng.lng);
        get_nearby_shops(e.latlng.lat,e.latlng.lng);
    }
    map.on('click', onMapClick);
    // Get shops as user moves the map
    function onMapMoveEnd() {
        map_center = map.getCenter();
        get_nearby_shops(map_center.lat,map_center.lng);
    }
    map.on('moveend', onMapMoveEnd);

    function get_nearby_shops(latitude,longitude) {
        if (shops_markers != undefined) {
            for (i = 0; i < shops_markers.length; i++) {
                map.removeLayer(shops_markers[i]);
            }
            shops_markers = []
        };
        $.ajax({
            headers: {'X-CSRFToken': '{{ csrf_token }}'},
            url: "/get_nearby_shops",
            type: "POST",
            dataType: "json",
            data: {
                'latitude': latitude,
                'longitude': longitude
            },
            // Make a marker for the shops nearby
            success: function(response){ 
                for (i = 0; i < response.success.length; i++) {
                    var temp_shops_markers = new L.marker([ response.success[i][0],response.success[i][1] ], {icon: customMarkerIcon, bd_name: response.success[i][2], bd_id: response.success[i][3]})
                    .addTo(map)
                    .bindPopup( response.success[i][2] )
                    .closePopup()
                    shops_markers.push(temp_shops_markers);
                };
            },
            error: function(response){ // This triggers in case all items in the basket get unavailable
                console.log(response);
            }
        });
    };
    function update_user_location(latitude,longitude) {
        $.ajax({
            headers: {'X-CSRFToken': '{{ csrf_token }}'},
            url: "/update_user_location",
            type: "POST",
            dataType: "json",
            data: {
                'latitude': latitude,
                'longitude': longitude
            },
            // Make a marker for the shops nearby
            success: function(response){ 
                ;
            },
            error: function(response){ // This triggers in case all items in the basket get unavailable
                ;
            }
        });
    }
</script>